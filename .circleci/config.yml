version: 2.1

orbs:
  cypress: cypress-io/cypress@1.7.0
  samson: contentful/trigger-samson@1
  polaris-scan: contentful/polaris-scan@1
  copy-assets:
    orbs:
      aws-s3: circleci/aws-s3@1.0.15
    jobs:
      to-s3:
        description: 'Build the image containing awscli and deploy assets to S3 using it'
        docker:
          - image: cimg/python:3.6
        steps:
          - attach_workspace:
              at: ~/workspace
          - checkout
          - run:
              name: Export preview AWS environment variables
              command: |
                echo 'export AWS_ACCESS_KEY_ID=${AWS_S3_PREVIEW_ACCESS_KEY_ID}' >> $BASH_ENV
                echo 'export AWS_SECRET_ACCESS_KEY=${AWS_S3_PREVIEW_SECRET_ACCESS_KEY}' >> $BASH_ENV
                echo 'export AWS_REGION="eu-west-1"' >> $BASH_ENV
          - aws-s3/copy:
              from: ~/workspace/output/files/preview/app
              to: s3://cf-preview-static-cdnorigin/app
              arguments: --acl public-read --recursive --cache-control "immutable,public,max-age=86400"
          - aws-s3/copy:
              from: ~/workspace/output/files/preview/archive
              to: s3://cf-preview-static-cdnorigin/archive
              arguments: --acl public-read --recursive --cache-control "no-cache"
          - run:
              name: Export staging AWS environment variables
              command: |
                echo 'export AWS_ACCESS_KEY_ID=${AWS_S3_STAGING_ACCESS_KEY_ID}' >> $BASH_ENV
                echo 'export AWS_SECRET_ACCESS_KEY=${AWS_S3_STAGING_SECRET_ACCESS_KEY}' >> $BASH_ENV
                echo 'export AWS_REGION="eu-west-1"' >> $BASH_ENV
          - aws-s3/copy:
              from: ~/workspace/output/files/staging/app
              to: s3://cf-staging-static-cdnorigin/app
              arguments: --acl public-read --recursive --cache-control "immutable,public,max-age=86400"
          - aws-s3/copy:
              from: ~/workspace/output/files/staging/archive
              to: s3://cf-staging-static-cdnorigin/archive
              arguments: --acl public-read --recursive --cache-control "no-cache"
          - run:
              name: Export staging AWS environment variables
              command: |
                echo 'export AWS_ACCESS_KEY_ID=${AWS_S3_PRODUCTION_ACCESS_KEY_ID}' >> $BASH_ENV
                echo 'export AWS_SECRET_ACCESS_KEY=${AWS_S3_PRODUCTION_SECRET_ACCESS_KEY}' >> $BASH_ENV
                echo 'export AWS_REGION="eu-west-1"' >> $BASH_ENV
          - aws-s3/copy:
              from: ~/workspace/output/files/production/app
              to: s3://static.cdnorigin.contentful.com/app
              arguments: --acl public-read --recursive --cache-control "immutable,public,max-age=86400"
          - aws-s3/copy:
              from: ~/workspace/output/files/production/archive
              to: s3://static.cdnorigin.contentful.com/archive
              arguments: --acl public-read --recursive --cache-control "no-cache"

  post-comment:
    commands:
      deployment:
        description: 'Post deployment URLs to PR'
        parameters:
          env:
            type: string
            description: 'quirely or flinkly'
        steps:
          - run:
              name: 'Post deployment URL to GitHub'
              command: |
                export PR_NUMBER=$(echo $CIRCLE_PULL_REQUEST | cut -d '/'  -f7)
                export LAMBDA_URL="https://tooling-lambdas.ctfl.now.sh/user_interface/comments"
                curl -i -X POST \
                --data-binary "{\"issue\": ${PR_NUMBER:-\"\"}, \"branch\": \"${CIRCLE_BRANCH}\", \"commitSha\": \"${CIRCLE_SHA1}\", \"env\": \"<<parameters.env>>\"}" \
                -H 'content-type: application/json' \
                $LAMBDA_URL?token=$GITHUB_PAT_REPO_SCOPE_SQUIRELY || echo "Comment won't be posted to ${PR_NUMBER:-$CIRCLE_BRANCH}. Continuing anyway."

  estivador:
    commands:
      install:
        description: 'Download estivador and validate checksum'
        steps:
          - run:
              name: Install estivador
              working_directory: ~/bin
              command: |
                curl -fsSLO https://contentful-lab-assets.s3.amazonaws.com/estivador && chmod +x estivador
                echo "$(curl -sSL https://contentful-lab-assets.s3.amazonaws.com/estivador.sum)" | sha512sum -c

  compose:
    commands:
      install:
        description: 'Download & install docker-compose'
        parameters:
          version:
            type: string
            default: '1.22.0'
        steps:
          - run:
              name: Install docker-compose
              command: |
                curl -L https://github.com/docker/compose/releases/download/<< parameters.version >>/docker-compose-`uname -s`-`uname -m` > docker-compose
                sudo mv docker-compose /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose
                docker-compose --version

  saucelabs:
    jobs:
      run:
        description: 'Run cross-browser tests on SauceLabs'
        parameters:
          browser:
            type: string
            default: 'chrome'
          platform:
            type: string
            default: 'Windows 10'
          selenium:
            type: string
            default: ''
        docker:
          - image: 806120774687.dkr.ecr.us-east-1.amazonaws.com/contentful/e2e-tests:facb043b5605c148be1985e567f8678aeda606f9
            aws_auth:
              aws_access_key_id: $AWS_ACCESS_KEY_ID
              aws_secret_access_key: $AWS_SECRET_ACCESS_KEY
        working_directory: /app
        steps:
          - run:
              name: Run e2e-tests for << parameters.browser >> browser
              command: |
                pytest -n=2 -d --max-worker-restart=2 --instafail --tb=short \
                --junit-xml=test-results/pytest/pytest-test-results.xml \
                --html=test-results/pytest/e2e-test-report.html \
                --pricing=v1 -m 'cross_browser' --driver SauceLabs \
                --capability browserName '<< parameters.browser >>' \
                --capability platform '<< parameters.platform >>' \
                --capability seleniumVersion '<< parameters.selenium >>'
          - store_artifacts:
              path: test-results
          - store_test_results:
              path: test-results

  ui-extensions-sdk:
    jobs:
      run:
        description: 'Run ui-extensions-sdk integration suite'
        docker:
          - image: cypress/browsers:node10.16.0-chrome77
            environment:
              TERM: xterm
        environment:
          CYPRESS_baseUrl: http://localhost:3001
          TEST_LOCAL_SDK: true
          UI_CONFIG: dev-on-production
        working_directory: /home/circleci/components/ui-extensions-sdk
        steps:
          - run:
              name: Provide NPM Token
              command: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          - checkout:
              path: /home/circleci/components/user_interface
          - run:
              name: Install user_interface dependencies
              working_directory: /home/circleci/components/user_interface
              command: npm ci
          - run:
              name: Clone master branch of ui-extensions-sdk
              command: git clone git@github.com:contentful/ui-extensions-sdk.git .
          - run:
              name: Install ui-extensions-sdk dependencies
              command: npm ci
          - run:
              name: Start user_interface locally
              working_directory: /home/circleci/components/user_interface
              command: npm start
              background: true
          - run:
              name: Wait http://localhost:3001/app/app.js to be ready
              command: npm run wait-for-app
          - run:
              name: Run integration tests
              environment:
                CYPRESS_RETRIES: 3
              command: |
                set -e
                npm run integration
          - run: npm run merge-report
          - run: npm run generate-report
          - store_artifacts:
              path: test/cypress/reports
          - store_artifacts:
              path: test/cypress/screenshots

parameters:
  # Required for microbackends side contract verification
  contract_url:
    type: string
    default: ''
  consumer_name:
    type: string
    default: 'all'
  consumer_version:
    type: string
    default: 'all'
  provider_version:
    type: string
    default: ''

run_only_on_master_branch: &run_only_on_master_branch
  filters:
    branches:
      only: master

executors:
  cypress-base-10:
    docker:
      - image: 'cypress/base:10'
    resource_class: large
    environment:
      NODE_ENV: dev
      UI_CONFIG: localhost

jobs:
  build-with-statistics:
    docker:
      - image: circleci/node:12.18.2
    environment:
      DOCKER_IMAGE: contentful/user_interface
      DOCKER_REGISTRY: 806120774687.dkr.ecr.us-east-1.amazonaws.com
      LOG: 'yesplease'
      CYPRESS_INSTALL_BINARY: 0
      COMMENT_LAMBDA_URL: https://tooling-lambdas.ctfl.now.sh/user_interface/githubComments
      SNIFFER_UPLOAD_URL: https://user-interface-sniffer.herokuapp.com
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - estivador/install
      - run:
          name: Setup environment variables
          command: |
            echo 'export SSH_KEY="$(openssl rsa -in ~/.ssh/id_rsa)"' >> $BASH_ENV
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
      - run: npm ci
      - run:
          name: Install Sniffer CLI tools
          command: npm install --no-save --no-shrinkwrap @contentful/project-sniffer-cli @contentful/sniffer-build-tracker
      - run:
          name: Run project sniffer and upload stats
          command: |
            export PR_NUMBER=$(echo $CIRCLE_PULL_REQUEST | cut -d '/'  -f7)
            npx project-sniffer . --config tools/sniffer
      - run:
          name: Build production image
          command: |
            docker-compose build production
      - run:
          name: Build assets image
          command: |
            # create a container from the "built" target
            # this is so that we can copy the output folder from it
            # This is extremely fast as all layers used by it are already
            # cached by building the production image earlier
            docker-compose up --no-start --build generate-assets
            docker cp user_interface-built-assets:app/output .
      - run:
          name: Push production image to our docker repo
          command: |
            ~/bin/estivador docker-ecr-login
            ~/bin/estivador put-image
            ~/bin/estivador promote-image
      - run:
          name: Upload build to user_interface build tracker server and post comment
          command: |
            export PR_NUMBER=$(echo $CIRCLE_PULL_REQUEST | cut -d '/'  -f7)
            export PATH_TO_BUILT_ASSETS='../output/files/production/app' # Path is relative to the config file
            npx sniffer-build-tracker version
            npx sniffer-build-tracker -vv stat-artifacts -c tools/sniffer-build-tracker.config.js
            npx sniffer-build-tracker upload-build -c tools/sniffer-build-tracker.config.js
      - run:
          name: Deploy micro-backends
          command: |
            export MICRO_BACKENDS_VERSION="0.7.0"
            export AWS_REGION="$MICRO_BACKENDS_AWS_REGION"
            export AWS_ACCESS_KEY_ID="$MICRO_BACKENDS_AWS_ACCESS_KEY_ID"
            export AWS_SECRET_ACCESS_KEY="$MICRO_BACKENDS_AWS_SECRET_ACCESS_KEY"

            echo "Using @contentful/micro-backends@$MICRO_BACKENDS_VERSION"
            npx "@contentful/micro-backends@$MICRO_BACKENDS_VERSION" "micro-backends" "rev-$CIRCLE_SHA1"
      - persist_to_workspace:
          root: .
          paths:
            - output
  lint:
    docker:
      - image: circleci/node:12.18.2
    environment:
      CYPRESS_INSTALL_BINARY: 0
    steps:
      - checkout
      - run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
      - run: echo 'export SSH_KEY="$(openssl rsa -in ~/.ssh/id_rsa)"' >> $BASH_ENV
      - run: npm ci
      - run: tools/bin/validate-config.js config/*.json
      - run:
          name: Check OSS licenses
          command: |
            npm install --no-save --no-shrinkwrap license-checker
            bin/oss-license-check
      - run: npm run check-types
      - run: npm run lint
      - run: npm run prettier:check
      - run: npm run cruise

  run-unit-tests:
    docker:
      - image: circleci/node:12.18.2-browsers
    environment:
      CYPRESS_INSTALL_BINARY: 0
      CI: true
    steps:
      - checkout
      - run:
          name: Setup environment
          command: |
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
            echo 'export SSH_KEY="$(openssl rsa -in ~/.ssh/id_rsa)"' >> $BASH_ENV
      - run: npm ci

      # Jest tests
      - run:
          name: Run Jest tests
          command: NODE_ENV=production npm run jest:coverage # cant set NODE_ENV in environment above since jest is a dev dep

      # Karma tests
      - run:
          name: Build test artifacts
          command: NODE_ENV=test node --max_old_space_size=3072 ./tools/bin/build-test.js
      - run:
          name: Run Karma tests
          command: |
            mkdir -p ./reports/karma
            npm run test:once
          environment:
            JUNIT_REPORT_PATH: ./reports/karma
            JUNIT_REPORT_NAME: karma-test-results.xml
      - store_test_results:
          path: reports

  publish-pact-contracts:
    docker:
      - image: pactfoundation/pact-cli:latest
    working_directory: ~/user_interface
    steps:
      - attach_workspace:
          at: ~/user_interface
      - run:
          name: Merge and publish contracts to pact-broker
          command: |
            PACT_FILES=$(circleci tests glob "/pact/user_interface/pacts/**/*.json")
            /pact/entrypoint.sh publish $PACT_FILES --consumer-app-version=$CIRCLE_SHA1 --tag=$CIRCLE_BRANCH

  verify-contracts: &verify-contracts
    machine:
      docker_layer_caching: true
    environment:
      CONTRACT_URL: << pipeline.parameters.contract_url >>
      CONSUMER_NAME: << pipeline.parameters.consumer_name >>
      CONSUMER_VERSION: << pipeline.parameters.consumer_version >>
      PROVIDER_SHA: << pipeline.parameters.provider_version >>
    steps:
      - checkout
      - when:
          condition: << pipeline.parameters.provider_version >>
          steps:
            - run: git checkout << pipeline.parameters.provider_version >>
      - run:
          name: Verify contracts
          command: |
            echo "Not yet implemented"

  verify-all-contracts:
    <<: *verify-contracts

workflows:
  build:
    unless: << pipeline.parameters.contract_url >>
    jobs:
      - lint
      - build-with-statistics:
          requires:
            - lint
      - run-unit-tests
      - polaris-scan/run-polaris-scan:
          requires_build: false
          context:
            - sast-scan
      - cypress/run:
          name: run-contract-tests
          no-workspace: true
          executor: cypress-base-10
          parallelism: 4
          pre-steps:
            - run: 'echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc'
          post-steps:
            - store_test_results:
                path: cypress/reports
            - persist_to_workspace:
                root: ~/project
                paths:
                  - pacts/*
          start: npm start
          command: |
            npm run wait-for-app
            TESTFILES=$(circleci tests glob "test/cypress/integration/**/*.ts" | circleci tests split --split-by=timings --timings-type=filename | tr '\n' ',')
            npx cypress run --spec "${TESTFILES}" --env PACT_DIR="./pacts/${CIRCLE_NODE_INDEX}"
          store_artifacts: true
      - publish-pact-contracts:
          requires:
            - run-contract-tests
      - copy-assets/to-s3:
          name: copy-assets-to-s3
          post-steps:
            - post-comment/deployment:
                env: 'flinkly'
          requires:
            - build-with-statistics
      # - ui-extensions-sdk/run:
      #     name: run-ui-extensions-integration
      - samson/trigger-samson:
          samson-url: https://samson.contentful.org/integrations/generic/24884e787b5439c88cedef3d8bf1ca90
          requires:
            - copy-assets-to-s3
      # - saucelabs/run:
      #     name: run-win10-edge-tests
      #     browser: 'MicrosoftEdge'
      #     selenium: '3.14.0'
      #     requires:
      #       - copy-assets-to-s3
      #     <<: *run_only_on_master_branch
      # - saucelabs/run:
      #     name: run-win10-firefox-tests
      #     browser: 'firefox'
      #     requires:
      #       - copy-assets-to-s3
      #     <<: *run_only_on_master_branch
verify-contract:
  when: << pipeline.parameters.contract_url >>
  jobs:
    - verify-contracts
