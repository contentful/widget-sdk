#!/bin/bash
#
# Build the contentful/user-interface image
#
# Uses the NPM_TOKEN environment variable or reads it from ~/.npmrc
#

set -e

if [[ -z "${NPM_TOKEN}" && -f "$HOME/.npmrc" ]]; then
  echo "Getting NPM token from ~/.npmrc"
  NPM_TOKEN=$( (grep -oE 'authToken=[0-9a-f-]{36}$' | grep -oE '[0-9a-f-]{36}' || true) < ~/.npmrc)
fi

if [[ -z "${NPM_TOKEN}" ]]; then
  echo "Please set the NPM_TOKEN environment variable or run 'npm login'" 1>&2
  exit 2
fi

echo "Building docker image"
docker build \
  --tag contentful/user-interface \
  --build-arg "NPM_TOKEN=${NPM_TOKEN}" \
  .
