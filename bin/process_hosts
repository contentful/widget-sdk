#!/usr/bin/env ruby
#encoding: UTF-8

require 'json'

config   = File.read('config/environment.json').gsub(/^\s+|\n/, '')
env      = ENV['UI_ENV'] || 'development'
settings = JSON.parse(config)

revision = JSON.parse(File.read('build/revision.json'))['revision']

configScript = <<-EOT
  <script id="cf-config">
    window.CF_CONFIG = #{config};
    window.CF_ENV = "#{env}";
    window.CF_UI_VERSION = "#{revision}"
  </script>
  EOT

INDEX = "build/index.html"
index = File.read(INDEX, encoding: 'utf-8')
index.gsub!(/<script id="cf-config">.*?<\/script>/m, configScript)
index.gsub!('static.joistio.com:8888', settings['asset_host'])
File.open(INDEX, 'w') do |file|
  file.write(index)
end
