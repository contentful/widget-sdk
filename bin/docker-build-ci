#!/bin/bash
#
# Build the contentful/user-interface-ci image with
# `Dockerfile-ci`. To run the ci image use `bin/docker-run-ci`.
#
# Uses the NPM_TOKEN environment variable or reads it from ~/.npmrc
# Uses the SSH_KEY environment variable or reads it from ~/.ssh/id_rsa when
# running in CI.
#

set -e

if [[ -z "${NPM_TOKEN}" && -f "$HOME/.npmrc" ]]; then
  echo "Getting NPM token from ~/.npmrc"
  NPM_TOKEN=$( (grep -oE 'authToken=[0-9a-f-]{36}$' | grep -oE '[0-9a-f-]{36}' || true) < ~/.npmrc)
fi

if [[ -z "${NPM_TOKEN}" ]]; then
  echo "Please set the NPM_TOKEN environment variable or run 'npm login'" 1>&2
  exit 2
fi

if [[ -z "${NODE_ENV}" ]]; then
  NODE_ENV=production
fi

if [[ ! -z "${CI}" ]]; then
  SSH_KEY=$(cat ~/.ssh/id_rsa)
fi

echo "Building docker image"
docker build \
  --file Dockerfile-ci \
  --tag contentful/user-interface-ci \
  --build-arg "NPM_TOKEN=${NPM_TOKEN}" \
  --build-arg "SSH_KEY=${SSH_KEY}" \
  --build-arg "NODE_ENV=${NODE_ENV}" \
  .
