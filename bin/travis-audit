#!/bin/bash

# The module `nsp` ships a npm-shrinkwrap.json file which is generated
# with npm 3 and causes issues in projects that are using npm 2. When
# adding `nsp` to the dev dependencies it will cause problems during
# the regeneration of the project's npm-shrinkwrap.json file. So
# instead of adding that, this script is installing nsp globally and
# can be called as a build step on travis.

npm install -g nsp

function runNsp () {
  nsp check -o summary npm-shrinkwrap.json
}

# Do not fail because of vulnerabilities in production deploy.
# If a new vulnerability is added to NSP right before the build we will
# be unable to deploy without making some commits.
if [[ "$TRAVIS_PULL_REQUEST" = "false" && "$TRAVIS_BRANCH" = "production" ]]; then
  runNsp || echo "Ignoring vulnerabitilies for production deploy"
else
  runNsp
fi
