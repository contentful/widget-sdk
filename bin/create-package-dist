#!/bin/bash
#
# Create the debian package from `./build`.
#

set -ex

umask 0022

if [[ -z "$TRAVIS_COMMIT" ]]; then
  echo "Environment variable TRAVIS_COMMIT is not set"
  exit 1
fi

# Version 2.x of the json gem does not work with ruby<2 which is used
# on travis by default.
which fpm >/dev/null || gem install 'json:<2.0' fpm

package_name="cf-user-interface"
version="0.$(date '+%s')-g$(git log -1 --pretty=format:%h)"

BUILD_ROOT=$(mktemp -d -t user-interface.XXXX.$version);

PACKAGE_ROOT=$BUILD_ROOT/opt/contentful/$package_name
mkdir -p $PACKAGE_ROOT/bin
cp -a build $PACKAGE_ROOT
cp -p bin/process_hosts $PACKAGE_ROOT/bin

fpm -t deb -s dir \
  -n $package_name \
  --version $version \
  --exclude '**/.nfs*' \
  -C $BUILD_ROOT \
  opt


PKG=$(ls cf-user-interface*.deb | head -n1)
POOL="archive/user_interface/pool"
GIT_SHA_DIR="archive/user_interface/git"

mkdir -p "$GIT_SHA_DIR" "$POOL"
echo "$POOL/$PKG" > "$GIT_SHA_DIR/$TRAVIS_COMMIT"
mv "$PKG" "$POOL"
