#!/bin/bash

# This script triggers a build of the UI Integration Test Suite on Jenkins.
#
# The script is run after the deployment and triggers a test run
# against the built commit on `app.flinkly.com`. Jenkins then sets the
# CI status on Github.
#
# For builds of the master branch we trigger the full test suite on the 'Staging
# Custom UI Version' job. We skip the preview and production branches. For all
# other branches we run the smoke tests on the 'User Interface Pull Request' job.
#
# The jenkins credentials are provided in encrypted form in
# `.travis.yml`. They are defined in the Jenkins Job configuration.

set -e

echo "------------------------------------"
echo "| Jenkins trigger script in Travis |"
echo "------------------------------------"
echo ""

# abort if tests failed
if [[ "$TRAVIS_TEST_RESULT" != "0" ]]; then
  echo "Skipping due to tests failure."
  exit $TRAVIS_TEST_RESULT;
fi

# abort if testing a merge commit
if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then
  echo "Skipping integration tests for PR build."
  exit 0;
fi

# abort if not a feature branch
if [[ "$TRAVIS_BRANCH" =~ ^(preview|production)$ ]]; then
  echo "Skipping integration tests for $TRAVIS_BRANCH branch builds."
  exit 0;
fi

if [[ "$TRAVIS_BRANCH" = "master" ]]; then
	JOB="staging-custom-ui-version"
else
	JOB="user-interface-pr"
fi

echo "Running ${JOB} for ${TRAVIS_BRANCH}."

AUTH="cf-ci:$JENKINS_PASSWORD"
CAUSE="Triggered+by+Travis+build+%23$TRAVIS_BUILD_ID+within+commit+$TRAVIS_COMMIT"
QUERY="token=$JENKINS_TOKEN&ui_version=$TRAVIS_COMMIT&cause=$CAUSE"
URL="https://jenkins.contentful.org/job/$JOB/buildWithParameters?$QUERY"

echo "POST $URL"
curl -X POST -i -u "$AUTH" --header "$JENKINS_CRUMB" --url "$URL"
