#!/usr/bin/env node
'use strict'

/**
 * This script removes unnecessary properties from
 * 'npm-shrinkwrap.json'. This reduces diff noise and makes `npm
 * install && npm shrinkwrap` idempotent.
 *
 * In particular we remove the `resolved` property and the `from`
 * property if it is not a URL.
 */

const fs = require('fs')

const URL_MATCHER = /^[\w+]+:\/\//
const SHRINKWRAP = __dirname + '/../npm-shrinkwrap.json'
const dependencies = require(SHRINKWRAP)
const cleaned = cleanDependency(dependencies)

fs.writeFileSync(SHRINKWRAP, `${JSON.stringify(cleaned, null, 2)}\n`, 'utf8')

function cleanDependency (dep) {
  delete dep.resolved;

  if (!URL_MATCHER.test(dep.from)) {
    delete dep.from
  }

  if (dep.dependencies) {
    const keys = Object.keys(dep.dependencies)
      .filter(key => !dep.dependencies[key].dev)
      .sort();

    dep.dependencies = keys.reduce((acc, key) => {
      acc[key] = cleanDependency(dep.dependencies[key]);
      return acc;
    }, {});
  }

  return dep
}
