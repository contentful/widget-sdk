#!/bin/bash
# This script triggers a build of the E2E Test Suite on Jenkins.
set -ex

echo "--------------------------------------"
echo "| Jenkins trigger script in CircleCI |"
echo "--------------------------------------"
echo ""

# abort if deployment was to preview
if [[ "$CIRCLE_BRANCH" =~ ^(preview)$ ]]; then
  echo "Skipping integration tests for $CIRCLE_BRANCH branch builds."
  exit 0;
fi

if [[ "$CIRCLE_BRANCH" =~ ^(master)$ ]]; then
  # For master we ALWAYS want to run e2e tests against those branches explicitly (i.e.
  # not the PR based branch)
  REF="$CIRCLE_BRANCH"
else
  if [ -z $CIRCLE_PULL_REQUEST ]; then
    # If we do NOT have a pull request, it probably means the branch was pushed but a PR not
    # yet created. So the ref will just be the branch name
    REF="$CIRCLE_BRANCH"
  else
    # If we have a pull request we will assign it a PR number as the ref
    PR_NUMBER=$(echo $CIRCLE_PULL_REQUEST | egrep -o "[0-9]+$")
    if [ -z "$PR_NUMBER" ]; then
      echo "No PR number or pull request found!"
      exit 1
    fi
    REF="PR-$PR_NUMBER"
  fi
fi

AUTH="cf-ci:$JENKINS_PASSWORD"
DATA="{ \"runPipeline\": \"true\", \"ref\": \"$REF\", \"repository\": \"user_interface\", \"sha\": \"$CIRCLE_SHA1\" }"
URL="https://jenkins.contentful.org/generic-webhook-trigger/invoke"
CURL="curl -X POST -i -u '$AUTH' -H 'Content-Type: application/json' -d '$DATA' --url '$URL'"

echo "Running e2e-tests for ${CIRCLE_BRANCH}."

echo $CURL
eval $CURL
