<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/promised_loader.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/promised_loader.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

angular.module('contentful').factory('PromisedLoader', /** @lends &lt;global> */ function ($q, $rootScope, cfSpinner) {
  /**
   * @class
   */
  var PromisedLoader = function PromisedLoader() {
    this.inProgress = false;
  };

  PromisedLoader.IN_PROGRESS = 'Already in progress';

  PromisedLoader.prototype = {
    startLoading: function () {
      this.stopSpinner = cfSpinner.start();
      this.inProgress = true;
    },

    endLoading: function() {
      this.inProgress = false;
      this.stopSpinner();
    },

    _loadCallback: _.debounce(function (host, methodName, args) {
      this.startLoading();
      host[methodName].apply(host, args);
    }, 500, {leading: true}),

    loadCallback: function (host, methodName/*, args[] */) {
      var deferred = $q.defer();
      var args = _.rest(arguments, 2);
      var loader = this;
      if (loader.inProgress){
        deferred.reject(PromisedLoader.IN_PROGRESS);
        return deferred.promise;
      }

      args.push(function callback(err, res, stats) {
        $rootScope.$apply(function () {
          if (err) {
            deferred.reject(err);
          } else {
            if (_.isObject(stats)) _.each(stats, function (stat, name) {
              Object.defineProperty(res, name, {value: stat});
            });
            deferred.resolve(res);
          }
          loader.endLoading();
        });
      });
      loader._loadCallback(host, methodName, args);

      return deferred.promise;
    },

    // Variant that delegates to loadPromise
    //loadCallback: function (host, methodName) {
      //var args = _.rest(arguments, 2);
      //return this.loadPromise(function (args) {
        //var cb = $q.callback();
        //args.push(cb);
        //host[methodName].apply(host, args);
        //return cb.promise.then(function (res, stats) {
          //if (_.isObject(stats)) _.each(stats, function (stat, name) {
            //Object.defineProperty(res, name, {value: stat});
          //});
        //});
      //}, args);
    //},

    _loadPromise: _.debounce(function (promiseLoader, args, deferred) {
      var loader = this;
      this.startLoading();
      promiseLoader.apply(null, args).then(function (res) {
        deferred.resolve(res);
        loader.endLoading();
      }, function (err) {
        deferred.reject(err);
        loader.endLoading();
      });
    }, 500, {leading: true}),

    loadPromise: function (promiseLoader/*, args[]*/) {
      var deferred = $q.defer();
      var args = _.rest(arguments, 1);
      if (this.inProgress){
        deferred.reject(PromisedLoader.IN_PROGRESS);
        return deferred.promise;
      }

      this._loadPromise(promiseLoader, args, deferred);

      return deferred.promise;
    }

  };

  return PromisedLoader;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-contentful.html">contentful</a></li></ul><h3>Classes</h3><ul><li><a href="-PromisedLoader.html">~PromisedLoader</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha8</a> on Sat Jun 14 2014 22:17:51 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
